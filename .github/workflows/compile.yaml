name: Arduino Compile

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compile Sketch
        uses: arduino/compile-sketches@v1
        with:
          fqbn: "arduino:avr:uno" 
          platforms: |
            - name: "arduino:avr"
          libraries: |
            - source-url: https://github.com/johnrickman/LiquidCrystal_I2C.git
            - source-url: https://github.com/MicroBeaut/Finite-State.git
          sketch-paths: |
            - TissueProcessor
          # This helper avoids failure if the folder structure is slightly off
          enable-deltas-report: true
        # NEW: This step parses the report file generated by the arduino action
      - name: Create Memory Badges
        if: github.event_name == 'push' # Only update on main branch pushes
        run: |
          # The report is saved as a JSON by the action. We extract the values.
          FLASH=$(jq '.sketches[0].sizes[0].usage' sketches-report.json)
          RAM=$(jq '.sketches[0].sizes[1].usage' sketches-report.json)
          echo "FLASH_USAGE=${FLASH} bytes" >> $GITHUB_ENV
          echo "RAM_USAGE=${RAM} bytes" >> $GITHUB_ENV

      - name: Update Flash Badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: YOUR_GIST_ID_HERE  # Create a secret Gist and paste ID here
          filename: flash.json
          label: Flash
          message: ${{ env.FLASH_USAGE }}
          color: blue

      - name: Update RAM Badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: YOUR_GIST_ID_HERE
          filename: ram.json
          label: RAM
          message: ${{ env.RAM_USAGE }}
          color: orange